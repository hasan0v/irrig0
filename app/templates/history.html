{% extends "base.html" %}

{% block title %}Geçmiş Veriler{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">Geçmiş Veriler</h1>
    <p>Sensor verilerinin geçmiş kayıtlarını görüntüleyin.</p>

    <!-- Control panel for chart configuration -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form id="history-form" class="row g-3">
                        <!-- Time range selection -->
                        <div class="col-md-4">
                            <label for="time-range" class="form-label">Zaman Aralığı</label>
                            <select id="time-range" class="form-select">
                                <option value="1h">Son 1 Saat</option>
                                <option value="6h">Son 6 Saat</option>
                                <option value="12h">Son 12 Saat</option>
                                <option value="24h" selected>Son 24 Saat</option>
                                <option value="3d">Son 3 Gün</option>
                                <option value="7d">Son 7 Gün</option>
                                <option value="30d">Son 30 Gün</option>
                                <option value="custom">Özel Tarih Aralığı</option>
                            </select>
                        </div>
                        
                        <!-- Custom date range (initially hidden) -->
                        <div class="col-md-8" id="custom-range-container" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="start-time" class="form-label">Başlangıç</label>
                                    <input type="datetime-local" id="start-time" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="end-time" class="form-label">Bitiş</label>
                                    <input type="datetime-local" id="end-time" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sensor selection -->
                        <div class="col-md-12">
                            <label class="form-label">Sensörler</label>
                            <div class="row" id="sensor-checkboxes">
                                <!-- Checkboxes will be generated by JavaScript -->
                                <div class="col-12">
                                    <p class="text-muted small">Sensörler yükleniyor...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Button group -->
                        <div class="col-12 d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" id="update-chart-btn">
                                <i class="bi bi-graph-up me-1"></i> Grafiği Güncelle
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" id="export-csv-btn" disabled>
                                <i class="bi bi-download me-1"></i> CSV İndir
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart display area -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div id="chart-container" style="height: 400px;">
                        <div id="chart-loading" class="d-flex justify-content-center align-items-center h-100">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted">Lütfen sensörleri ve zaman aralığını seçin...</p>
                            </div>
                        </div>
                        <canvas id="history-chart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data summary section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Veri Özeti</h5>
                </div>
                <div class="card-body">
                    <div id="data-summary" class="row">
                        <div class="col-12">
                            <p class="text-muted text-center">Veri gösterilemiyor. Lütfen önce bir grafik oluşturun.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
    // DOM elements
    const timeRangeSelect = document.getElementById('time-range');
    const customRangeContainer = document.getElementById('custom-range-container');
    const startTimeInput = document.getElementById('start-time');
    const endTimeInput = document.getElementById('end-time');
    const sensorCheckboxesContainer = document.getElementById('sensor-checkboxes');
    const updateChartBtn = document.getElementById('update-chart-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const chartContainer = document.getElementById('chart-container');
    const chartLoading = document.getElementById('chart-loading');
    const historyChart = document.getElementById('history-chart');
    const dataSummary = document.getElementById('data-summary');
    
    // Available sensors and their display names
    const availableSensors = [
        { id: 'temperature', name: 'Sıcaklık', unit: '°C', color: 'rgb(255, 99, 132)' },
        { id: 'humidity', name: 'Nem', unit: '%', color: 'rgb(54, 162, 235)' },
        { id: 'soil_moisture_level', name: 'Toprak Nemi', unit: '%', color: 'rgb(75, 192, 192)' },
        { id: 'ph_level', name: 'pH Seviyesi', unit: '', color: 'rgb(153, 102, 255)' },
        { id: 'uv_intensity', name: 'UV Yoğunluğu', unit: '', color: 'rgb(255, 159, 64)' },
        { id: 'rainfall', name: 'Yağış', unit: 'mm', color: 'rgb(201, 203, 207)' },
        { id: 'tank_water_volume', name: 'Tank Su Seviyesi', unit: 'L', color: 'rgb(0, 128, 255)' },
        { id: 'water_pressure', name: 'Su Basıncı', unit: 'bar', color: 'rgb(0, 102, 204)' }
    ];
    
    // Chart instance
    let chart = null;
    // Current chart data
    let currentData = null;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Populate sensor checkboxes
        populateSensorCheckboxes();
        
        // Set up event listeners
        setupEventListeners();
        
        // Initialize default time values
        initializeTimeInputs();
    });
    
    function populateSensorCheckboxes() {
        sensorCheckboxesContainer.innerHTML = '';
        
        // Create a row with 3 columns per row for checkboxes
        availableSensors.forEach((sensor, index) => {
            if (index % 3 === 0) {
                // Create a new row for every 3 sensors
                currentRow = document.createElement('div');
                currentRow.className = 'row mb-2';
                sensorCheckboxesContainer.appendChild(currentRow);
            }
            
            // Create column
            const col = document.createElement('div');
            col.className = 'col-md-4';
            
            // Create checkbox with label
            const checkboxId = `sensor-${sensor.id}`;
            const checkbox = document.createElement('div');
            checkbox.className = 'form-check';
            checkbox.innerHTML = `
                <input class="form-check-input sensor-checkbox" type="checkbox" id="${checkboxId}" value="${sensor.id}">
                <label class="form-check-label" for="${checkboxId}">
                    ${sensor.name} <small class="text-muted">(${sensor.unit})</small>
                </label>
            `;
            
            col.appendChild(checkbox);
            sensorCheckboxesContainer.lastChild.appendChild(col);
        });
        
        // Pre-select temperature and humidity by default
        if (document.getElementById('sensor-temperature')) {
            document.getElementById('sensor-temperature').checked = true;
        }
        if (document.getElementById('sensor-humidity')) {
            document.getElementById('sensor-humidity').checked = true;
        }
    }
    
    function setupEventListeners() {
        // Time range change event
        timeRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customRangeContainer.style.display = 'block';
            } else {
                customRangeContainer.style.display = 'none';
                // Auto-update chart when selecting a preset time range
                updateChart();
            }
        });
        
        // Update chart button
        updateChartBtn.addEventListener('click', updateChart);
        
        // Export CSV button
        exportCsvBtn.addEventListener('click', exportCSV);
    }
    
    function initializeTimeInputs() {
        // Set default end time to now
        const now = new Date();
        endTimeInput.value = formatDateTimeForInput(now);
        
        // Set default start time to 24 hours ago
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        startTimeInput.value = formatDateTimeForInput(yesterday);
    }
    
    function formatDateTimeForInput(date) {
        return `${date.getFullYear()}-${padZero(date.getMonth() + 1)}-${padZero(date.getDate())}T${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
    }
    
    function padZero(num) {
        return num.toString().padStart(2, '0');
    }
    
    async function updateChart() {
        // Show loading state
        historyChart.style.display = 'none';
        chartLoading.style.display = 'flex';
        chartLoading.querySelector('p').textContent = 'Veriler yükleniyor...';
        
        try {
            // Get selected sensors
            const selectedSensors = Array.from(document.querySelectorAll('.sensor-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedSensors.length === 0) {
                chartLoading.querySelector('p').textContent = 'Lütfen en az bir sensör seçin';
                return;
            }
            
            // Get time range
            let startTime, endTime;
            
            if (timeRangeSelect.value === 'custom') {
                startTime = startTimeInput.value;
                endTime = endTimeInput.value;
                
                if (!startTime || !endTime) {
                    chartLoading.querySelector('p').textContent = 'Lütfen tarih aralığını belirtin';
                    return;
                }
            } else {
                // Calculate time range based on selection
                endTime = new Date();
                startTime = new Date();
                
                switch (timeRangeSelect.value) {
                    case '1h': startTime.setHours(endTime.getHours() - 1); break;
                    case '6h': startTime.setHours(endTime.getHours() - 6); break;
                    case '12h': startTime.setHours(endTime.getHours() - 12); break;
                    case '24h': startTime.setDate(endTime.getDate() - 1); break;
                    case '3d': startTime.setDate(endTime.getDate() - 3); break;
                    case '7d': startTime.setDate(endTime.getDate() - 7); break;
                    case '30d': startTime.setDate(endTime.getDate() - 30); break;
                }
                
                startTime = startTime.toISOString();
                endTime = endTime.toISOString();
            }
            
            // Fetch historical data
            const response = await fetch(`{{ url_for('api_historical_data') }}?sensors=${selectedSensors.join(',')}&start_time=${startTime}&end_time=${endTime}`);
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = "{{ url_for('login') }}";
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            currentData = data; // Store for possible export
            
            // Enable export button if we have data
            exportCsvBtn.disabled = data.timestamps.length === 0;
            
            if (data.timestamps.length === 0) {
                chartLoading.querySelector('p').textContent = 'Seçilen zaman aralığında veri bulunamadı';
                return;
            }
            
            // Render chart
            renderChart(data, selectedSensors);
            
            // Update data summary
            updateDataSummary(data, selectedSensors);
            
        } catch (error) {
            console.error('Error fetching historical data:', error);
            chartLoading.querySelector('p').textContent = 'Veriler yüklenirken hata oluştu: ' + error.message;
        }
    }
    
    function renderChart(data, selectedSensors) {
        // Format dates for display
        const formattedDates = data.timestamps.map(timestamp => {
            const date = new Date(timestamp);
            return date.toLocaleString();
        });
        
        // Prepare datasets
        const datasets = selectedSensors.map(sensorId => {
            const sensor = availableSensors.find(s => s.id === sensorId);
            return {
                label: sensor ? `${sensor.name} ${sensor.unit ? `(${sensor.unit})` : ''}` : sensorId,
                data: data.sensors[sensorId],
                borderColor: sensor ? sensor.color : 'rgb(0, 0, 0)',
                backgroundColor: sensor ? sensor.color + '33' : 'rgba(0, 0, 0, 0.2)', // Add alpha
                borderWidth: 2,
                tension: 0.2, // Slightly curved lines
                fill: false,
                pointRadius: data.timestamps.length > 100 ? 0 : 3, // Hide points for large datasets
            };
        });
        
        // Destroy previous chart if exists
        if (chart) {
            chart.destroy();
        }
        
        // Create new chart
        chart = new Chart(historyChart, {
            type: 'line',
            data: {
                labels: formattedDates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Zaman'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 20
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Değer'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
        
        // Show chart, hide loading
        historyChart.style.display = 'block';
        chartLoading.style.display = 'none';
    }
    
    function updateDataSummary(data, selectedSensors) {
        // Generate summary HTML
        let summaryHTML = `
            <div class="col-12 mb-3">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Toplam ${data.metadata.count} veri noktası görüntüleniyor.
                    ${data.metadata.aggregated ? 
                        `(Orijinal ${data.metadata.original_count} noktadan örneklenmiştir.)` : ''}
                </div>
            </div>
        `;
        
        // Create a table for each selected sensor
        selectedSensors.forEach(sensorId => {
            const sensorValues = data.sensors[sensorId].filter(v => v !== null);
            if (sensorValues.length === 0) return;
            
            const sensor = availableSensors.find(s => s.id === sensorId);
            const name = sensor ? sensor.name : sensorId;
            const unit = sensor ? sensor.unit : '';
            
            // Calculate statistics
            const min = Math.min(...sensorValues);
            const max = Math.max(...sensorValues);
            const avg = sensorValues.reduce((sum, val) => sum + val, 0) / sensorValues.length;
            const current = sensorValues[sensorValues.length - 1];
            
            // Add card for each sensor
            summaryHTML += `
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">${name}</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td>Minimum</td>
                                    <td class="text-end">${min.toFixed(2)} ${unit}</td>
                                </tr>
                                <tr>
                                    <td>Maksimum</td>
                                    <td class="text-end">${max.toFixed(2)} ${unit}</td>
                                </tr>
                                <tr>
                                    <td>Ortalama</td>
                                    <td class="text-end">${avg.toFixed(2)} ${unit}</td>
                                </tr>
                                <tr>
                                    <td>Son Değer</td>
                                    <td class="text-end">${current.toFixed(2)} ${unit}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Update summary container
        dataSummary.innerHTML = summaryHTML;
    }
    
    function exportCSV() {
        if (!currentData || !currentData.timestamps.length) {
            alert('İndirilecek veri yok.');
            return;
        }
        
        // Get selected sensors
        const selectedSensors = Array.from(document.querySelectorAll('.sensor-checkbox:checked'))
            .map(checkbox => checkbox.value);
            
        // Create CSV header
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Create header row
        let headers = ["Timestamp"];
        selectedSensors.forEach(sensorId => {
            const sensor = availableSensors.find(s => s.id === sensorId);
            headers.push(sensor ? sensor.name : sensorId);
        });
        csvContent += headers.join(",") + "\r\n";
        
        // Add data rows
        for (let i = 0; i < currentData.timestamps.length; i++) {
            let row = [currentData.timestamps[i]];
            
            selectedSensors.forEach(sensorId => {
                row.push(currentData.sensors[sensorId][i] || "");
            });
            
            csvContent += row.join(",") + "\r\n";
        }
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        
        // Create filename based on date range
        const startDate = new Date(currentData.timestamps[0]).toISOString().split('T')[0];
        const endDate = new Date(currentData.timestamps[currentData.timestamps.length - 1]).toISOString().split('T')[0];
        link.setAttribute("download", `sensor_data_${startDate}_to_${endDate}.csv`);
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
